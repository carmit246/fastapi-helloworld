name: Deploy Backend Service

on:
  workflow_call:
   inputs:
      env:
        required: true
        type: string 
      repository-uri:
        required: true
        type: string
      image-tag:
        required: true
        type: string
      image-name:
        required: false
        type: string
        default: test1-app

  workflow_dispatch:
    env:
      required: true
      type: string 
    repository-uri:
      required: true
      type: string
    image-tag:
      required: true
      type: string
    image-name:
      required: false
      type: string
      default: test1-app

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --name ${{ secrets.EKS_CLUSTER_NAME }} \
            --region ${{ secrets.AWS_REGION }}

      - name: Deploy with Helm
        run: |
          helm upgrade --install helloworld ./helm/helloworld \
            --namespace backend \
            --create-namespace \
            --set image.repository=${{ inputs.repository-uri }}/${{ inputs.image-name}} \
            --set image.tag=${{ inputs.image-tag }} \
            --wait \
            --timeout 5m

      - name: Verify deployment
        run: |
          helm status helloworld -n backend
          kubectl get all -n backend -l app.kubernetes.io/instance=helloworld

      - name: Summarize
        run: |
          echo "âœ… **Backend Deployed to ${{ inputs.env}}: ${{ inputs.repository-uri }}/${{ inputs.image-name}}:${{ inputs.image-tag }}" >> "$GITHUB_STEP_SUMMARY"