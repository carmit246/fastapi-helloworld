name: Deploy Backend Service

on:
  workflow_call:
   inputs:
      env:
        required: true
        type: string 
      repository-uri:
        required: true
        type: string
      image-tag:
        required: true
        type: string
      image-name:
        required: false
        type: string
        default: test1-app
      deployment-type:
        required: false
        type: string
        default: argocd

  workflow_dispatch:
    inputs:
      env:
        required: true 
        type: choice
        default: "dev"
        options: 
        - dev
      repository-uri:
        required: true
        type: string
      image-tag:
        required: true
        type: string
      image-name:
        required: false
        type: string
        default: test1-app
      deployment-type:
        required: false
        type: choice
        default: "argocd"
        options: 
        - argocd
        - helm

jobs:
  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy helm chart
        if: ${{ inputs.deployment-type == 'helm' }}
        uses: ./.github/actions/deploy-helm
        with:
          env:  ${{ inputs.env }}
          repository-uri: ${{ inputs.repository-uri }}
          image-tag: ${{ inputs.image-tag }}
          image-name: ${{ inputs.image-name}}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
          eks-cluster: ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Deploy argocd application
        if: ${{ inputs.deployment-type == 'argocd' }}
        uses: ./.github/actions/deploy-argocd
        with:
          env:  ${{ inputs.env }}
          repository-uri: ${{ inputs.repository-uri }}
          image-tag: ${{ inputs.image-tag }}
          image-name: ${{ inputs.image-name}}
          token: ${{ github.token }}

      - name: Summarize
        run: |
          echo "âœ… **Backend Deployed to ${{ inputs.env}}: ${{ inputs.repository-uri }}/${{ inputs.image-name}}:${{ inputs.image-tag }}" >> "$GITHUB_STEP_SUMMARY"
